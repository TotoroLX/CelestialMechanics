% some test
muM = 4902.799; % km3/s2 -- mu Moon from Vallado
muE = 3.986004415e5; % km3/s2 -- mu Earth from Vallado
mu = muM/(muE + muM); % 0.012150581477177

epsilon = 1.e-4;

% mu=3.054248395728148e-06;

eqNum = 3;
nFam = 5;

Ax1 = 0.02;%0.150834272416660;
Ax2 = 0.021;

% Ax1=0.0001,Az=0.001 chaos
% Ax1=0.00001,Az=Ax*10 can check this t=1.35
%------------------------------ Halo Orbits 1 -----------------------------
%x0poGuess = [0.988360555400675;0.004481176568162;0;...
%    -0.098106749679581;-1.644397521594456;1.640416175720395]; DAMP=0.01
%x0poGuess = [0.844765770471713;-0.056805336483208;0;...
%    -0.035952982443933;-0.014098375874756;0.025389558388583]; DAMP=0.1
%x0poGuess = [0.844773669725930;0.056797450827903;0;...
%    0.035937934139835;-0.014165971617849;0.025388819810539]; DAMP=0.1
%x0poGuess = [0.987080533067444;-0.027216335836602;0;...
%    -0.113218729948413;-0.621170469770948;0.664658830988097]; DAMP=0.1
%x0poGuess = [0.844647937718099;-0.056447317105796;0;...
%    -0.035690452273597;-0.014094362504229;0.021170335874687];
%x0poGuess = [0.987531141083140;-0.019688890594046;0; ...
%    -0.106522063200883;-0.749793291684750;0.781812222457726]; tf = 1.805 
%x0poGuess = [0.987805231309835;-0.008664892436038;0; ...
%    -0.098361162265932;-1.172178741073455;1.181424863754109]; tf = 1.805 
%------------------------------- Halo Orbits ------------------------------
% x0=[0.943553185939109;0.015497025068962;0;...
%     0.531332017860071;0.123268245892669;0.492528079554908];2.626258844894558
% x0=[0.943044654344087;0.015457998465568;0;...
%     0.529230173375609;0.126443076098463;0.489184926164547];2.631633602321876
% x0=[0.982856786261038;0.006870087813461;0;...
%     0.811403580811102;-0.825753551531886;1.235426483336298];2.162928613406002
% x0=[0.981663286978653;0.007315903443993;0;...
%     0.835888084370029;-0.699097787821255;1.163991740515774];2.178107511735337
% x0=[1.005479389865741;0.013646216133220;0;...
%     -0.495538562327786;-0.639498716376086;0.665866054417634];2.263995684068486
% x0=[1.005052153879725;0.012903125990372;0;...
%     -0.517336624975045;-0.638267215803521;0.681107898103560];2.266515810647406
% x0=[1.005831296108898;0.013219448029302;0;...
%     -0.510967053044670;-0.626205244003947;0.666891491237200];2.273570879725431
% x0=[1.007397738688967;0.013878844597625;0;...
%     -0.497932060595133;-0.604614567048500;0.640203339837680];2.288103871185747
% x0=[1.016359937117348;0.017471419518325;0;...
%     -0.434112286607389;-0.521287544848413;0.528583777389106];2.368423122606387
% x0=[1.031221934685759;0.024010801655346;0;...
%     -0.352089065107875;-0.457977577671954;0.418935108976313];2.501564132191694
% x0=[1.026953597092422;0.022361440096865;0;...
%     -0.369253965977198;-0.472923197320486;0.443083835108287];2.461519765759422
% x0=[1.030886158712089;0.024166166515731;0;...
%     -0.350314110367999;-0.460506443289485;0.419640575009179];2.496125236219684
% x0=[1.009271330859460;0.015333412320826;0;...
%     -0.466288176931208;-0.590286317286946;0.604999021698881];2.299382820723760
% x0=[1.057726010973495;0.038554376818750;0;...
%     -0.250681335420820;-0.419185343065547;0.314751047117090];2.741597991432257
% x0=[1.064738587680264;0.043271849989847;0;...
%     -0.228972884865106;-0.415519399604692;0.296458227967495];2.806484236626749
% x0=[1.141757375396668;0.161461289991517;0;...
%     -0.003266212653614;-0.435288086168592;0.184094688871538];3.702827564582187
% x0=[1.1119594054551374;0.0;0;...
%     0.0;-0.18124841270866476;0.43576411644659757]; 4.423308886403689
% x0=[0.87642891534439826;0.0;0.0;...
%     0.0;0.0090290217274574605;0.46553952107519370]; 4.060839820175107

%------------------------------ Halo Orbits 2 -----------------------------

%------------------------------- Strange Halo Orbits ----------------------
%x0poGuess = [0.862426028825487;-0.021312308977649;0...
%    0.025022945507023;,-0.089351053939445;-0.000022783822845]; t=1.971223

%------------------------------- Strange Orbit ----------------------------
%x0poGuess = [0.887911342171318;0.024497114276565;0;...
%    -0.061479877419433;-0.163946912108601;0.000006478457629];
%x0poGuess = [0.890411228752778;0.030140913129931;0;...
%    -0.078102415851946;-0.157942586610908;0.000002464086029];
%------------------------------- Strange Orbit ----------------------------
%x0poGuess = [0.990340558586517;-0.400757208128699;0;...
%    -0.817906479025302;-1.876758621775707;0.000000000411322];
%x0poGuess = [0.986592972666191;0.003242305457621;0;...
%    -0.002090849734669;-0.002669076741617;2.388504937220767];
%------------------------------- Needs to check ---------------------------
%---x0poGuess = [0.988376509662022;-0.003754225017534;0;...
%    -0.287984138074821;1.721888434815146;1.797606152027762]; t=1.15184
%------------------------------- Unstable Manifold ------------------------
%x0poGuess = [0.845041522522392;-0.059040469899917;0;...
%    -0.037547084705200;-0.013392491504160;0.001311981015149];
%--------------------------------------------------------------------------

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% test code %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% [x0poGuess, TGuess] = poGuessLinear3BP3d(mu, eqNum, Ax1);
% [x0poGuess, TGuess] = poGuessLinear3BP3d(mu, eqNum, Ax2);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% test code %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Used differential correction
[x0po, T] = poFam3BP3d(mu, eqNum, Ax1, Ax2, nFam, epsilon);

%RelTol = 3.e-14 ; AbsTol = 1.e-16; % high accuracy;
%RelTol = 3.e-10 ; AbsTol = 1.e-12; % low accuracy
RelTol = 3.e-06 ; AbsTol = 1.e-09; % lowest accuracy

OPTIONS = odeset('RelTol',RelTol,'AbsTol',AbsTol);

% load x0po_T_SVD_L1_1.dat
% x0po = x0po_T_SVD_L1_1(:,1:6);
% T = x0po_T_SVD_L1_1(:,end);

%for k = 7
figure()
hold on
for k = nFam:-1:1
    x0 = x0po(k,1:6) ;
%     x0 = x01;
    tf = T(k) ;
%     tf = 2.743682854845483;
    [x,t] = trajGet3BP3d(x0,tf,mu,OPTIONS) ;
    plot3(x(:,1),x(:,3),x(:,2),'.-', 'MarkerSize', 2);
    plot3(x(1,1),x(1,3),x(1,2),'r*', 'MarkerSize', 2);
    plot3(x(end,1),x(end,3),x(end,2),'ro', 'MarkerSize', 2);
    hold on
    pause(0.01) ;
end
xlabel('X');
ylabel('Z');
zlabel('Y');
grid on
plot3(-1.005062644785412,0,0,'ks')
% L3:-1.005062644785412
plot3(-mu,0,0,'ko')

title("Halo orbit with SVD method")

%%

x0_=[[0.943553185939109;0.015497025068962;0;...
    0.531332017860071;0.123268245892669;0.492528079554908;2.626258844894558],...
    [0.943044654344087;0.015457998465568;0;...
    0.529230173375609;0.126443076098463;0.489184926164547;2.631633602321876],...
    [0.982856786261038;0.006870087813461;0;...
    0.811403580811102;-0.825753551531886;1.235426483336298;2.162928613406002],...
    [0.981663286978653;0.007315903443993;0;...
    0.835888084370029;-0.699097787821255;1.163991740515774;2.178107511735337],...
    [1.005479389865741;0.013646216133220;0;...
    -0.495538562327786;-0.639498716376086;0.665866054417634;2.263995684068486],...
    [1.005052153879725;0.012903125990372;0;...
    -0.517336624975045;-0.638267215803521;0.681107898103560;2.266515810647406],...
    [1.005831296108898;0.013219448029302;0;...
    -0.510967053044670;-0.626205244003947;0.666891491237200;2.273570879725431],...
    [1.007397738688967;0.013878844597625;0;...
    -0.497932060595133;-0.604614567048500;0.640203339837680;2.288103871185747],...
    [1.016359937117348;0.017471419518325;0;...
    -0.434112286607389;-0.521287544848413;0.528583777389106;2.368423122606387],...
    [1.031221934685759;0.024010801655346;0;...
    -0.352089065107875;-0.457977577671954;0.418935108976313;2.501564132191694],...
    [1.026953597092422;0.022361440096865;0;...
    -0.369253965977198;-0.472923197320486;0.443083835108287;2.461519765759422],...
    [1.030886158712089;0.024166166515731;0;...
    -0.350314110367999;-0.460506443289485;0.419640575009179;2.496125236219684],...
    [1.009271330859460;0.015333412320826;0;...
    -0.466288176931208;-0.590286317286946;0.604999021698881;2.299382820723760],...
    [1.057726010973495;0.038554376818750;0;...
    -0.250681335420820;-0.419185343065547;0.314751047117090;2.741597991432257],...
    [1.064738587680264;0.043271849989847;0;...
    -0.228972884865106;-0.415519399604692;0.296458227967495;2.806484236626749],...
    [1.141757375396668;0.161461289991517;0;...
    -0.003266212653614;-0.435288086168592;0.184094688871538;3.702827564582187],...
    [1.1119594054551374;0.0;0;...
    0.0;-0.18124841270866476;0.43576411644659757; 4.423308886403689],...
    [0.87642891534439826;0.0;0.0;...
    0.0;0.0090290217274574605;0.46553952107519370; 4.060839820175107]];

load x0po_T_SVD_L1.dat
load x0po_T_SVD_L3_29.dat

x0s = x0po_T_SVD_L3_29;

for l = 12:29
    filename_ = strcat('x0po_T_SVD_L3_', num2str(l), '.dat');
    x0s = [x0s; load(filename_)];
end
    
% x0s = [x0po_T_SVD_L1_1; x0_'; x0po_T_SVD_L1];

figure()
hold on
for k = 1:1:size(x0s,1)
    x0 = x0s(k, 1:6) ;
    tf = x0s(k, end);
    [x,t] = trajGet3BP3d(x0,tf,mu,OPTIONS) ;
    plot3(x(:,1),x(:,2),x(:,3),'b.-', 'MarkerSize',2);
    plot3(x(1,1),x(1,2),x(1,3),'r*', 'MarkerSize',2);
    plot3(x(end,1),x(end,2),x(end,3),'ro', 'MarkerSize',2);
    hold on
    pause(0.001) ;
end
xlabel('X');
ylabel('Y');
zlabel('Z');
grid on
plot3(0.836915146106164,0,0,'ks')
plot3(1.155733835140644,0,0,'ks')
plot3(1-mu,0,0,'ko')

title("Halo orbit with SVD method L3")
